# 15장. Kafka 소켓 버퍼 크기 설정

Kafka는 네트워크를 통해 데이터를 주고받는 시스템입니다. 이때 Kafka 브로커는 보내거나 받는 데이터를 일시적으로 담아두는 **소켓 버퍼(Socket Buffer)** 를 사용합니다. 이 버퍼가 충분하지 않으면 빠른 네트워크에서도 데이터를 처리하지 못해 성능 저하나 데이터 유실이 발생할 수 있습니다.

---

## 15.1 소켓 버퍼란?

소켓 버퍼는 **TCP 통신에서 데이터를 임시로 저장하는 공간**입니다. Kafka는 데이터를 주고받을 때, 이 공간을 거쳐 송수신을 하게 되며, 버퍼가 작으면 처리 속도가 줄어들고, 버퍼가 충분하면 성능을 안정적으로 유지할 수 있습니다.

---

## 15.2 버퍼 크기는 어떻게 정할까? (BDP 기반)

버퍼 크기를 정할 때 사용하는 기준이 바로 **BDP(Bandwidth Delay Product)** 입니다.

### 📘 BDP란?
BDP는 "네트워크 대역폭과 지연 시간(RTT)을 고려하여, 버퍼에 저장할 수 있는 최적의 데이터 양"입니다.

### 공식:
```
BDP = 네트워크 속도(Gbps) × 왕복 지연 시간(RTT, 초) ÷ 8
```
> bit 단위 대역폭을 byte로 바꾸기 위해 ÷ 8을 합니다.

---

## 15.3 예시: BDP 계산하기

### 조건
- NIC(Network Interface Card) 속도: 10Gbps
- 왕복 지연 시간(RTT): 50ms (0.05초)

### 계산
```
BDP = 10 × 0.05 ÷ 8 = 0.0625 GB = 62.5MB
```

👉 네트워크를 충분히 활용하려면 **최소 62.5MB 소켓 버퍼가 필요**합니다.

> 실무에서는 BDP의 1.5~2배 정도로 여유를 주는 것이 일반적입니다.

---

## 15.4 설정 방법

### Linux 커널 설정 (`/etc/sysctl.conf`)
```bash
net.core.rmem_max = 67108864      # 수신 버퍼 최대 64MB
net.core.wmem_max = 67108864      # 송신 버퍼 최대 64MB
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
```
적용 명령어:
```bash
sudo sysctl -p
```

### Kafka 설정 (`server.properties`)
```properties
socket.receive.buffer.bytes=67108864
socket.send.buffer.bytes=67108864
```
이 설정은 클라이언트나 브로커 간 데이터 전송 속도에 영향을 줍니다.

---

## 15.5 NIC 속도별 버퍼 추천값 (RTT 50ms 기준)

| NIC 속도 | 최소 버퍼 (BDP 기준) |
|-----------|------------------------|
| 1Gbps     | 6.25MB                 |
| 10Gbps    | 62.5MB                 |
| 25Gbps    | 156.25MB               |
| 100Gbps   | 625MB                  |

---

## 15.6 확인 및 측정 팁

- RTT 측정: `ping [IP주소]`
- NIC 속도 확인: `ethtool eth0` (eth0는 인터페이스명)

이 가이드는 Kafka뿐 아니라 Nginx, Redis, PostgreSQL 등 TCP 통신 기반 프로그램에도 동일하게 적용할 수 있습니다.
