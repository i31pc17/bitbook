# 10장. Kafka 메모리 선택 가이드 (KRaft 기반)

Kafka는 데이터를 저장하고 처리하는 시스템입니다. 이 과정에서 가장 중요한 자원 중 하나가 바로 "메모리"입니다. 이 장에서는 Kafka를 처음 접하는 사람도 이해할 수 있도록, **메모리가 왜 중요한지**, **어떻게 구성되는지**, **얼마나 필요할지**를 차근차근 설명합니다.

## 10.1 Kafka에서 말하는 '메모리'란?

컴퓨터의 메모리(RAM)는 데이터를 빠르게 처리하기 위해 사용하는 임시 공간입니다. Kafka는 데이터를 저장하고 전송하는 프로그램인데, 여러 작업을 빠르게 처리하기 위해 메모리를 여러 방식으로 사용합니다.

Kafka는 크게 아래 두 가지 방식으로 메모리를 사용합니다:

- **JVM Heap**: Kafka 프로그램이 직접 사용하는 공간
- **OS Page Cache**: 운영체제가 파일을 디스크에 저장하기 전, 잠깐 보관하는 공간

---

## 10.2 JVM Heap과 Page Cache 쉽게 이해하기

| 항목 | 누가 사용하는가? | 무엇에 쓰는가? | 부족하면 어떻게 될까? |
|------|------------------|------------------|----------------------|
| JVM Heap | Kafka 프로그램 | Kafka 내부 데이터 처리, 큐 관리, 임시 객체 저장 등 | 오류 발생, 처리 지연, GC 시간 증가 |
| OS Page Cache | 운영체제 | 디스크에 쓰기 전 데이터를 잠깐 담아둠 | 디스크 쓰기/읽기 느려짐 |

### 예시 설명:
- Kafka가 메시지를 처리하면서 생성한 내부 객체들은 JVM Heap에 저장됩니다.
- 반면, 디스크에 저장할 로그 파일은 운영체제가 Page Cache에 잠깐 저장했다가 나중에 디스크에 기록합니다.

둘 다 충분히 확보되지 않으면 Kafka 성능이 크게 떨어지거나 문제가 발생할 수 있습니다.

---

## 10.3 Kafka에서 메모리가 왜 중요할까?

Kafka는 실시간으로 많은 데이터를 주고받고, 파일로 저장도 해야 합니다. 이 모든 작업이 매끄럽게 이뤄지기 위해서는 메모리를 적절히 나눠서 사용하는 것이 매우 중요합니다.

만약 메모리가 부족하다면:
- 프로그램이 중단되거나 느려지고
- 디스크 쓰기가 느려지며
- 복제나 압축 작업이 실패할 수도 있습니다.

---

## 10.4 노드별 메모리 권장 기준

| Kafka 노드 역할 | 권장 메모리 용량 |
|------------------|------------------|
| 브로커 전용 | 8 ~ 32 GB |
| 컨트롤러 전용 (KRaft) | 4 ~ 8 GB |
| 브로커 + 컨트롤러 겸용 | 16 ~ 64 GB |

> Kafka는 Java 기반 애플리케이션이기 때문에 너무 적은 메모리는 GC 지연을 유발할 수 있습니다.

---

## 10.5 노드 역할에 따른 메모리 사용 특징

### 브로커 전용 노드
- 주로 데이터를 받고, 저장하고, 복제하는 역할을 합니다.
- Page Cache, 복제 버퍼, 네트워크 버퍼가 중요합니다.

### 컨트롤러 전용 노드 (KRaft)
- Kafka 클러스터 전체의 설정과 상태를 관리합니다.
- 메모리 사용량은 적지만, **안정적인 GC가 중요**합니다.

### 겸용 노드 (브로커 + 컨트롤러)
- 위 두 가지 역할을 동시에 수행합니다.
- 메모리는 여유 있게 확보해야 합니다.

---

## 10.6 메모리 구성 요소 기본 개념

Kafka에서 메모리는 단순히 “크기”뿐 아니라 **구성 방식**에 따라 성능이 달라집니다. 아래는 Kafka 서버용 메모리를 선택할 때 반드시 알고 있어야 할 기본 용어입니다:

### ✅ 클럭 속도 (Memory Clock Speed)
- 메모리가 동작하는 속도를 MHz 단위로 표현한 수치입니다.
- 예: `DDR4-2666`, `DDR5-4800` → 숫자가 높을수록 빠른 처리 가능
- 클럭 속도가 높으면 데이터 전송 속도(대역폭)가 향상됩니다.

### ✅ 메모리 타입 (Memory Type)
- DRAM 기술 세대를 의미하며, 현재는 `DDR4` 또는 `DDR5`가 주로 사용됩니다.
- **DDR5**는 DDR4에 비해 더 높은 대역폭과 낮은 전력 소비를 제공합니다.
- 메인보드와 CPU가 해당 세대를 지원해야 사용할 수 있습니다.

### ✅ 채널 구성 (Memory Channel Configuration)
- CPU와 메모리 사이 데이터 전송 경로 개수입니다.
- `듀얼채널`은 2개의 채널, `쿼드채널`은 4개의 채널로 병렬 처리됨.
- 채널 수가 많을수록 대역폭이 증가하므로 Kafka의 I/O 성능 향상에 유리합니다.
- 예: 같은 16GiB 메모리라도 8GiB×2 듀얼채널 구성 > 16GiB×1 단일채널 구성

---

## 10.7 Kafka 메모리 구성 예시 (32GB 기준)

Kafka가 어떻게 메모리를 사용하는지 예시로 살펴봅시다:

```text
총 메모리: 32GB일 때 예시 구성

- JVM Heap: 12 GB (Kafka 내부 처리용)
- Page Cache: 8 GB (디스크 저장 전에 임시 보관)
- 복제/네트워크 버퍼: 4 GB (Kafka가 메시지를 여러 브로커로 복제하거나, 프로듀서/컨슈머와 데이터를 주고받을 때 잠시 머무는 공간)
- KRaft 메타데이터 처리: 2 GB
- 여유(Margin): 6 GB (시스템 안정성 확보용)
```

이처럼 여러 영역에 메모리를 나눠 쓰는 것이 안정적인 운영에 도움이 됩니다.

---

## 10.8 메모리가 많이 필요한 상황은?

| 상황 | 이유 |
|------|------|
| 파티션 수가 10,000 이상 | 파티션 정보를 메모리에 유지해야 함 |
| 대형 클러스터에서 컨트롤러가 리더인 경우 | 메타데이터 snapshot 용량 커짐 |
| 로그 flush 주기가 길고 압축 사용 | Page Cache, 압축 버퍼 사용 증가 |
| Tiered Storage 사용 (S3 등) | 로컬과 원격 저장소의 메타데이터 캐시 필요 |

---

## 10.9 구성별 권장 메모리 요약표

| 구성 환경 | 권장 메모리 |
|------------|-------------|
| 브로커 전용 (압축 사용, SSD) | 16 ~ 32 GB |
| 컨트롤러 전용 (파티션 수 많음) | 6 ~ 12 GB |
| 겸용 노드 (일반적인 중소형 클러스터) | 24 ~ 48 GB |
| 겸용 노드 (대형, Tiered Storage 포함) | 64 GB 이상 |

---

## 10.10 Kafka 메모리 운영 팁

- **GC 튜닝**: G1GC 사용, 최대 pause time 줄이기
- **numactl 사용**: NUMA 환경에서 메모리 지역화
- **메모리 모니터링**: Grafana + Prometheus 연동 추천
- **문제 발생 대비**: Heap dump, GC log 활성화

---

> ✅ 정리: Zookeeper가 없는 KRaft 환경에서는 컨트롤러의 메모리 안정성도 매우 중요합니다.  
Kafka가 멈추지 않고 잘 동작하려면, 메모리는 넉넉하고 균형 있게 나눠주는 것이 가장 중요합니다.